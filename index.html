<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2035 æœªæ¥å‡ºè¡Œ</title>
<style>
  :root{
    --bg:#060913;          /* æ·±å¤œåº•è‰² */
    --ink:#0b1220;         /* æ·±å¤œå¢¨è“ */
    --hud:#00ffd0;         /* HUD é’ç»¿ */
    --hud2:#5edfff;        /* HUD ç”µè“ */
    --card:#0e1626;        /* é¢æ¿åº• */
    --text:#e6f7ff;        /* æ–‡å­—é«˜äº® */
    --muted:#9fb4c6;       /* æ¬¡çº§æ–‡å­— */
    --border:rgba(255,255,255,.12);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC",sans-serif;overflow-x:hidden}

  /* ===== èƒŒæ™¯ï¼šâ‘¡ è„‘æ³¢é“¾æ¥ + â‘¢ æ˜Ÿç©ºæ²‰æµ¸ï¼ˆèåˆï¼‰ ===== */
  /* æ˜Ÿç©ºå±‚ï¼ˆæ›´å¤šæ˜Ÿç‚¹ + å¾®å‘¼å¸ï¼‰ */
  .stars, .stars::before, .stars::after{
    position:fixed;inset:0;content:"";pointer-events:none;z-index:-3
  }
  .stars{
    background:
      radial-gradient(1.5px 1.5px at 20% 30%, rgba(255,255,255,.45), transparent),
      radial-gradient(1px 1px     at 70% 60%, rgba(255,255,255,.35), transparent),
      radial-gradient(1px 1px     at 40% 80%, rgba(255,255,255,.28), transparent),
      radial-gradient(2px 2px     at 60% 15%, rgba(255,215,130,.18), transparent);
    animation: twinkle 6s ease-in-out infinite;
  }
  .stars::before{
    background:
      radial-gradient(800px 600px at 50% 15%, rgba(20,40,90,.35), transparent 60%),
      radial-gradient(900px 700px at 80% 120%, rgba(12,20,36,.45), transparent 60%);
    z-index:-4;
  }
  .stars::after{
    background:
      radial-gradient(1200px 900px at 10% 110%, rgba(0,60,140,.18), transparent 65%),
      radial-gradient(1000px 800px at 100% 0%,  rgba(0,200,160,.12), transparent 65%);
    filter: blur(2px); opacity:.8; z-index:-5;
  }
  @keyframes twinkle{0%{opacity:.9}50%{opacity:.5}100%{opacity:.9}}

  /* HUD ç¥ç»ç½‘ç»œçº¿ï¼ˆæ·¡ç½‘æ ¼ + ä¸­å¤®è„‰å†²æ³¢ï¼‰ */
  .hud-grid::before{
    content:"";position:fixed;inset:0;z-index:-2;pointer-events:none;
    background-image:
      linear-gradient(rgba(0,255,208,.06) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,255,208,.06) 1px, transparent 1px);
    background-size:48px 48px;
    opacity:.25;filter:blur(.4px);
  }
  .neuro{
    position:fixed;inset:0;z-index:-1;pointer-events:none;
    display:flex;align-items:center;justify-content:center;
  }
  /* ä¸­å¤®è„‰å†²ç¯ */
  .pulse{
    width:42vmin;height:42vmin;border-radius:50%;
    background: radial-gradient(closest-side, rgba(0,255,208,.14), rgba(0,255,208,0) 60%);
    box-shadow:0 0 60px rgba(0,255,208,.18) inset;
    animation:pulse 5.5s ease-in-out infinite;
    mask: radial-gradient(circle at 50% 50%, rgba(255,255,255,.9), transparent 62%);
  }
  @keyframes pulse{
    0%{transform:scale(0.98);opacity:.75}
    50%{transform:scale(1.03);opacity:1}
    100%{transform:scale(0.98);opacity:.75}
  }
  /* è„‘æ³¢çº¿ï¼ˆSVGæè¾¹åŠ¨ç”»ï¼‰ */
  .wave{
    position:absolute;width:86vmin;height:34vmin;opacity:.6;filter:drop-shadow(0 0 8px rgba(94,223,255,.2));
    animation: float 9s ease-in-out infinite;
  }
  @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
  .wave path{
    fill:none;stroke:url(#grad);stroke-width:1.5;
    stroke-dasharray:260;stroke-dashoffset:520;
    animation:dash 6s linear infinite;
  }
  @keyframes dash{to{stroke-dashoffset:0}}

  .wrap{max-width:680px;margin:0 auto;padding:32px 18px 120px}
  header{display:flex;align-items:center;gap:10px;margin:8px 0 16px 0}
  .dot{width:10px;height:10px;border-radius:50%;background:var(--hud);box-shadow:0 0 14px var(--hud)}
  h1{font-size:22px;margin:0;font-weight:700}
  .sub{color:var(--muted);font-size:13px}

  .progress{height:6px;background:#111a29;border-radius:999px;overflow:hidden;margin:12px 0 8px;border:1px solid var(--border)}
  .bar{height:100%;background:linear-gradient(90deg,var(--hud),var(--hud2));width:0%;transition:width .25s ease}

  .card{background:rgba(14,22,38,.75);backdrop-filter: blur(12px) saturate(120%);border:1px solid var(--border);border-radius:18px;box-shadow:0 12px 36px rgba(0,0,0,.45);padding:20px;margin:14px 0}
  .q{font-size:18px;line-height:1.6;margin-bottom:8px}
  .hint{opacity:.8;font-size:13px;color:var(--muted);margin:4px 0 12px}
  .chip{padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.03);cursor:pointer;display:flex;justify-content:space-between;align-items:center;margin:8px 0;transition:.18s}
  .chip:hover{border-color:rgba(0,255,208,.35);background:rgba(0,255,208,.06)}
  .chip.sel{border-color:var(--hud);background:rgba(0,255,208,.18);box-shadow:0 0 0 3px rgba(0,255,208,.18)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{padding:12px 16px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);cursor:pointer}
  .btn.primary{border-color:var(--hud);background:linear-gradient(180deg, rgba(0,255,208,.22), rgba(0,255,208,.06));box-shadow:0 8px 20px rgba(0,255,208,.22)}
  .actions{display:flex;gap:10px;margin-top:12px}
  .muted{opacity:.7;color:var(--muted)}
  input[type=range]{width:100%}

  .result{background:rgba(0,0,0,.5);border:1px solid var(--border);border-radius:18px;padding:18px;display:none}
  textarea{width:100%;min-height:120px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);padding:12px;resize:vertical;outline:none}
</style>
</head>
<body>
<!-- èƒŒæ™¯ï¼šæ˜Ÿç©º + HUD ç½‘æ ¼ + ä¸­å¤®è„‘æ³¢è„‰å†² -->
<div class="stars"></div>
<div class="hud-grid"></div>
<div class="neuro">
  <div class="pulse"></div>
  <svg class="wave" viewBox="0 0 600 220" preserveAspectRatio="none">
    <defs>
      <linearGradient id="grad" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%" stop-color="#00ffd0"/><stop offset="100%" stop-color="#5edfff"/>
      </linearGradient>
    </defs>
    <path d="M0,110 C60,60 120,160 180,110 C240,60 300,160 360,110 C420,60 480,160 540,110 C560,95 580,100 600,110" />
  </svg>
</div>

<div class="wrap">
  <header>
    <div class="dot"></div>
    <div>
      <h1>2035 æœªæ¥å‡ºè¡Œ</h1>
      <div class="sub">æ²‰æµ¸å¼ Â· çœŸå®å¯ç”¨ Â· æ•°æ®é©±åŠ¨</div>
    </div>
  </header>

  <div class="progress"><div id="bar" class="bar"></div></div>

  <div id="panel" class="card">
    <div id="qtext" class="q"></div>
    <div id="hint" class="hint"></div>
    <div id="opts"></div>
    <div class="actions">
      <button class="btn" id="prevBtn" onclick="prev()" style="display:none">ä¸Šä¸€æ­¥</button>
      <button class="btn primary" id="nextBtn" onclick="next()">ç»§ç»­</button>
    </div>
  </div>

  <div id="result" class="result"></div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
/* ============ 0) Supabase + ä¼šè¯ ============ */
const SUPABASE_URL = "https://xrsthdmcujustsezwaln.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhyc3RoZG1jdWp1c3RzZXp3YWxuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NzkxMzAsImV4cCI6MjA3NzM1NTEzMH0.i3iGszKjV6UAnG9HpT7o9p83QMT84z2GJ1V5fDawdD0";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ç”Ÿæˆä¸€ä¸ªä¼šè¯ idï¼ˆç”¨äºèšåˆåŒä¸€ä»½ä½œç­”ï¼‰
const session_id = (crypto && crypto.randomUUID) ? crypto.randomUUID() :
                   'sess_'+Math.random().toString(36).slice(2)+Date.now();

/* ============ 1) é¦–æ¬¡/é‡å¤ä½œç­” é€‰æ‹©é€»è¾‘ ============ */
let allowRecord = !localStorage.getItem('survey_done');
if (!allowRecord) {
  const msg = "ç³»ç»Ÿæ£€æµ‹åˆ°ä½ å·²æäº¤è¿‡ä¸€æ¬¡é—®å·ã€‚\n\nã€ç¡®å®šã€‘è¦†ç›–æ—§è®°å½•ï¼Œé‡æ–°æäº¤\nã€å–æ¶ˆã€‘æœ¬æ¬¡ä»…ä½“éªŒï¼Œä¸è®°å½•æ•°æ®";
  if (confirm(msg)) {
    localStorage.removeItem('survey_done');
    allowRecord = true;
  } else {
    allowRecord = false;
    window.skipLog = true;
  }
}

/* ============ 2) é—®é¢˜é›†ï¼ˆ16é¢˜ï¼Œæ–‡æ¡ˆæ›´é€šä¿—ï¼‰ ============ */
/* type: 'single' å•é€‰ | 'multi' å¤šé€‰ï¼ˆmaxï¼‰ | 'likert' äº”çº§ | 'sliders' äº”ä¸ªæ»‘æ¡ | 'rank' ç‚¹å‡»æ’åº | 'open' æ–‡æœ¬ */
const quiz = [
  // â…  æœªæ¥èº«ä»½åæ ‡
  {key:'age_stage', type:'single', q:'2035å¹´ï¼Œä½ é¢„è®¡ä¼šå¤„äºå“ªä¸ªäººç”Ÿé˜¶æ®µï¼Ÿ', hint:'ç”¨äºç†è§£å‡ºè¡Œè´£ä»»ä¸ç”Ÿæ´»èŠ‚å¥',
   opts:[
     'â‰¤25ï½œæ¢ç´¢ä¸èµ·æ­¥ï¼ˆå­¦ç”Ÿ / åˆå…¥èŒåœºï¼‰',
     '26â€“35ï½œæˆé•¿ä¸æ•ˆç‡ï¼ˆäº‹ä¸šç§¯ç´¯ / å¯èƒ½æˆå®¶ï¼‰',
     '36â€“45ï½œå¹³è¡¡ä¸æ„å»ºï¼ˆå®¶åº­+äº‹ä¸šåŒçº¿ï¼‰',
     '46â€“55ï½œæˆç†Ÿä¸æ‹“å±•ï¼ˆç¨³å®šä¸æ‹“å®½ï¼‰',
     '56â€“65ï½œèˆ’é€‚ä¸é•¿ç¨‹ä½“éªŒ',
     'â‰¥66ï½œé™ªä¼´ä¸å¥åº·'
   ]},
  {key:'city_tier', type:'single', q:'2035å¹´ï¼Œä½ é¢„è®¡æ‰€åœ¨çš„åŸå¸‚ç±»å‹æ˜¯ï¼Ÿ', hint:'ä¸åŒåŸå¸‚å‡ºè¡Œç»“æ„å·®åˆ«',
   opts:[
     'ä¸€çº¿/è¶…çº§åŸå¸‚ï¼ˆåŒ—ä¸Šå¹¿æ·±â€¦ï¼‰',
     'æ–°ä¸€çº¿/çœä¼šï¼ˆæˆéƒ½/æ­å·/æ­¦æ±‰â€¦ï¼‰',
     'åœ°çº§å¸‚ï¼ˆå¤§éƒ¨åˆ†åŸå¸‚ï¼‰',
     'å¿åŸ/å°åŸï¼ˆèŠ‚å¥æ›´èˆ’é€‚ï¼‰',
     'ä¹¡é•‡/ä¹¡é‡ï¼ˆè‡ªç„¶ã€è·ç¦»æ›´é•¿ï¼‰'
   ]},
  {key:'family', type:'single', q:'2035å¹´ï¼Œä½ çš„å®¶åº­/åŒè¡Œç»“æ„ï¼Ÿ', hint:'å½±å“ç©ºé—´ä¸æœåŠ¡éœ€æ±‚',
   opts:['å•äººç”Ÿæ´»æˆ–ç‹¬å±…','ä¼´ä¾£åŒè¡Œ','æ ¸å¿ƒå®¶åº­ï¼ˆå«å­å¥³ï¼‰','å¤šä»£å…±å±…/è·¨å¹´é¾„å®¶åº­','å…¶ä»–/çµæ´»ç»“æ„']},

  // â…¡ è¡ŒåŠ¨æ¨¡å¼ä¸å‡ºè¡Œè¯­å¢ƒ
  {key:'purpose', type:'multi', max:3, q:'2035å¹´ï¼Œä½ æ—¥å¸¸å‡ºè¡Œä¸»è¦ç›®çš„æœ€å¯èƒ½æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆæœ€å¤šé€‰3ï¼‰', hint:'è¯·é€‰æ‹©è´´è¿‘ä½ æ—¥å¸¸çš„åœºæ™¯',
   opts:['é€šå‹¤ï¼ˆä¸Šç­/ä¸Šå­¦ï¼‰','å®¶åº­ç…§æŠ¤/å­©å­å‡ºè¡Œ','å•†åŠ¡æ´»åŠ¨','åŸå¸‚ç”Ÿæ´»ä½“éªŒï¼ˆé€›é€›/è¿åŠ¨/å’–å•¡ï¼‰','åŸé™…/é•¿é€”å‡ºè¡Œ','ç§»åŠ¨åŠå…¬/å­¦ä¹ ','å…¶ä»–']},
  {key:'daily_km', type:'single', q:'ä½ æ¯å¤©çš„å¤§æ¦‚ç§»åŠ¨è·ç¦»ï¼Ÿ', hint:'ç›´è§‰å‚è€ƒï¼šä¸Šç­é€šå‹¤çº¦ 10â€“25km',
   opts:[
     '0â€“30kmï½œé™„è¿‘ç”Ÿæ´»åœˆ / çŸ­é€šå‹¤',
     '31â€“60kmï½œè·¨åŸåŒºé€šå‹¤',
     '61â€“100kmï½œå¤§éƒ½å¸‚ç©¿è¡Œ',
     '101â€“150kmï½œè·¨åŸè¾¹ç¼˜é€šå‹¤',
     '150km+ï½œé•¿ç¨‹ç§»åŠ¨ / åŸé™…ç”Ÿæ´»'
   ]},
  {key:'time_slot', type:'single', q:'2035å¹´ï¼Œä½ çš„å‡ºè¡Œæ—¶é—´æ›´åå‘ï¼Ÿ', hint:'é€‰æ‹©æœ€å¸¸è§çš„ä¸€ä¸ª',
   opts:['æ—©é«˜å³°/ä¸Šåˆ','ç™½å¤©ä¸ºä¸»','æ—©æ™šé«˜å³°ç©¿è¡Œ','å¤œé—´åå¤š','ä¸å›ºå®š/å–å†³å®‰æ’']},
  {key:'freq', type:'single', q:'å‡ºè¡Œé¢‘ç‡æ›´æ¥è¿‘ï¼Ÿ', hint:'èŠ‚å¥æ„Ÿå—',
   opts:['å¶å°” / éæ—¥å¸¸','æ¯å¤©å›ºå®šå¾€è¿”','é«˜å¼ºåº¦å¤šèŠ‚ç‚¹ï¼ˆå¤šåœ°ç©¿è¡Œï¼‰','çµæ„Ÿä¸éœ€æ±‚é©±åŠ¨ï¼ˆçµæ´»å·¥ä½œï¼‰']},

  // â…¢ å…¬å…±ç³»ç»ŸååŒ
  {key:'public_share', type:'likert', q:'æœªæ¥ä½ ä¼šå¤šå¤§ç¨‹åº¦ä¾èµ–åŸå¸‚äº¤é€šä¸å…±äº«ç³»ç»Ÿï¼Ÿ', hint:'1=å‡ ä¹ä¸ç”¨ï¼Œ5=å‡ ä¹ä¸è€ƒè™‘ç§å®¶è½¦', opts:['1','2','3','4','5']},

  // â…£ æœªæ¥ç§»åŠ¨ä½“å½¢æ€ä¸åå¥½
  {key:'form', type:'single', q:'ä½ æœ€å–œæ¬¢çš„æœªæ¥å‡ºè¡Œå½¢æ€ï¼Ÿ', hint:'é€‰æ‹©ä½ æ›´æ„¿æ„é•¿æœŸç›¸å¤„çš„å½¢æ€',
   opts:[
     'âš¡ è¿›åŒ–èƒ½é‡åº§èˆ±ï½œåƒç§äººç©ºé—´èˆ±ï¼Œå®‰å…¨å®‰é™',
     'ğŸ¾ ä»¿ç”Ÿå…±ç”Ÿä½“ï½œæœ‰æƒ…æ„Ÿçš„é™ªä¼´ä½“ï¼Œåƒâ€œæœºå® /çµå…½â€',
     'ğŸŒ« æµåŠ¨ç©ºé—´ï½œåƒæˆ¿é—´éšä½ å±•å¼€/æ”¶æ‹¢',
     'ğŸ§  ç¥ç»é€šè·¯ï½œæ²‰æµ¸å¼â€œå¿ƒæ™ºæ—…è¡Œ/æ„è¯†æ·±æ½œâ€',
     'ğŸŒ€ è‡ªå®šä¹‰èåˆï½œå½¢æ€éšä»»åŠ¡å˜åŒ–'
   ]},

  // 10ï¼šäº”é¡¹åŸå‹æ‰“åˆ†ï¼ˆæ»‘æ¡ï¼‰
  {key:'prototype_scores', type:'sliders', q:'è¯·ä¸ºä»¥ä¸‹åŸå‹æ‰“åˆ†ï¼ˆ1â€“5ï¼‰', hint:'å‘å³æ›´å–œæ¬¢',
   sliders:[
     {key:'A_èƒ½é‡åº§èˆ±', label:'A èƒ½é‡åº§èˆ±ï¼ˆé£è¡Œèˆ±/èƒ½é‡èˆ±ï¼‰', min:1, max:5, val:3},
     {key:'B_ä»¿ç”Ÿå½¢æ€', label:'B ä»¿ç”Ÿå½¢æ€/çµå…½ï¼ˆæ¤ç‰©/åŠ¨ç‰©é™ªä¼´ï¼‰', min:1, max:5, val:3},
     {key:'C_ç©ºé—´å˜æ¢', label:'C ç©ºé—´å˜æ¢å¼ç§»åŠ¨ï¼ˆåƒæˆ¿é—´æ»‘åŠ¨ï¼‰', min:1, max:5, val:3},
     {key:'D_ç¥ç»æ·±æ½œ', label:'D ç¥ç»æ·±æ½œ/æ„è¯†æ—…è¡Œ', min:1, max:5, val:3},
     {key:'E_è‡ªå®šä¹‰å˜å½¢', label:'E è‡ªå®šä¹‰å˜å½¢æ¨¡å¼', min:1, max:5, val:3},
   ]},

  // â…¤ è‡ªåŠ¨é©¾é©¶ä¸æ„ŸçŸ¥äº¤ä»˜
  {key:'autonomy', type:'single', q:'ä½ æ„¿æ„è®©å‡ºå¤šå°‘â€œé©¾é©¶æƒé™â€ï¼Ÿ', hint:'é€‰æ‹©ä½ æœ€èˆ’é€‚çš„æ¨¡å¼',
   opts:['æˆ‘è‡ªå·±å¼€ä¸ºä¸»','æˆ‘ä¸»é©¾+AIè¾…åŠ©','AIä¸»é©¾+æˆ‘ç›‘ç£','å…¨è‡ªåŠ¨ï¼ˆæ— æ–¹å‘ç›˜ï¼‰','æ„è¯†æ§åˆ¶/èåˆé©¾é©¶']},

  {key:'in_cabin', type:'single', q:'ä½ è§‰å¾—2035å¹´ï¼Œè½¦å†…çš„ä½ æœ€å¸¸å¤„äºä»€ä¹ˆçŠ¶æ€ï¼Ÿ', hint:'å†³å®šèˆ±å†…æ¨¡å¼åå¥½',
   opts:['ä¼‘æ¯æ¢å¤','å¨±ä¹æ²‰æµ¸','å·¥ä½œå­¦ä¹ ','å†¥æƒ³/é™å¿ƒ','ç¤¾äº¤äº¤æµ']},

  // â…¥ èˆ±å†…èƒ½åŠ›
  {key:'features', type:'multi', max:4, q:'ä½ æ›´çœ‹é‡å“ªäº›èˆ±å†…èƒ½åŠ›ï¼Ÿï¼ˆæœ€å¤šé€‰4ï¼‰', hint:'é€‰æ‹©æœ€é‡è¦çš„åŠŸèƒ½',
   opts:['AIåŠ©ç†ä¸è‡ªåŠ¨åŒ–','èˆ’é€‚åº§èˆ±/åº§æ¤…æ™ºèƒ½','æ²‰æµ¸å£°åœº/æ°›å›´','å¥åº·ä¸æƒ…ç»ªç›‘æµ‹','é«˜é€Ÿäº’è”/å¯¼èˆªååŒ','å¯å˜ç©ºé—´/æ”¶çº³','æˆ·å¤–æ‹“å±•ï¼ˆéœ²è¥/ä¾›ç”µï¼‰','å…¶ä»–']},

  {key:'ota', type:'single', q:'ä½ å¸Œæœ›ç§»åŠ¨ä½“æ˜¯å¦â€œåƒæ‰‹æœºä¸€æ ·ä¸æ–­å‡çº§â€ï¼Ÿ', hint:'è½¦è¾†å¯é€šè¿‡ç½‘ç»œè‡ªåŠ¨æ›´æ–°åŠŸèƒ½/ä¿®å¤é—®é¢˜/é€æ­¥å˜å¼º',
   opts:['ä¸éœ€è¦','å¯é€‰æ‹©å‡çº§','å®šæœŸåŠŸèƒ½æ›´æ–°','é«˜åº¦ä¾èµ–æ›´æ–°','ç†æƒ³ï¼šè‡ªåŠ¨å‡çº§ï¼Œä½“éªŒè¶Šæ¥è¶Šå¼º']},

  // â…¦ ä»·å€¼æ’åºï¼ˆç‚¹å‡»é€‰å‡ºä¼˜å…ˆé¡ºåºï¼šå®ç°Bæ–¹æ¡ˆï¼‰
  {key:'priority', type:'rank', q:'å¯¹ä½ æ¥è¯´ï¼Œä»¥ä¸‹å› ç´ çš„ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼Ÿ', hint:'ç‚¹å‡»æ¡ç›®ä¾æ¬¡é€‰å‡ºç¬¬1ï½ç¬¬8ä½ï¼›å¯é‡ç½®',
   items:['å®‰å…¨','æ™ºèƒ½ä¸è‡ªåŠ¨åŒ–èƒ½åŠ›','å¤–è§‚ä¸è®¾è®¡','èˆ’é€‚ä¸ç©ºé—´','å“ç‰Œ/ä¿¡ä»»æ„Ÿ','èƒ½è€—æˆæœ¬','ç¯å¢ƒå‹å¥½','ä»·æ ¼é¢„ç®—']},

  // â…§ å¼€æ”¾å¼
  {key:'open', type:'open', q:'ç”¨ä¸€å¥è¯ï¼Œæè¿°ä½ å¿ƒä¸­çš„ 2035 ç†æƒ³ç§»åŠ¨ä½“éªŒ', hint:'ä¾‹å¦‚ï¼šâ€œåƒä¸€ä¸ªéšèº«æºå¸¦çš„å®é™èƒ½é‡ç©ºé—´â€ã€‚'}
];

/* ============ 3) è¿è¡Œé€»è¾‘ ============ */
let i = -1;                 // å½“å‰é¢˜ç›®ç´¢å¼•
const answers = {};         // æ”¶é›†ç­”æ¡ˆï¼škey -> value
const qEl = document.getElementById('qtext');
const hintEl = document.getElementById('hint');
const optsEl = document.getElementById('opts');
const barEl = document.getElementById('bar');
const panelEl = document.getElementById('panel');
const resultEl = document.getElementById('result');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');

function prev(){ if(i<=0) return; i--; render(); }
function next(){ i++; if(i>=quiz.length){ finish(); return; } render(); }
function setProgress(){ barEl.style.width = (i/quiz.length*100)+'%'; }

function render(){
  prevBtn.style.display = i>0? 'inline-flex':'none';
  setProgress();
  const q = quiz[i];
  qEl.textContent = q.q;
  hintEl.textContent = q.hint || '';
  optsEl.innerHTML = '';
  nextBtn.style.display = (q.type==='single' || q.type==='likert') ? 'none' : 'inline-flex';

  if(q.type==='single'){
    q.opts.forEach(opt=>{
      const d = document.createElement('div'); d.className = 'chip'; d.textContent = opt;
      d.onclick = ()=>{ answers[q.key] = opt; logStep(q.key, q.q, opt); next(); };
      optsEl.appendChild(d);
    });
  }
  else if(q.type==='multi'){
    const max = q.max || 99;
    const picked = new Set(answers[q.key]||[]);
    q.opts.forEach(opt=>{
      const d = document.createElement('div'); d.className='chip'; d.textContent=opt;
      if(picked.has(opt)) d.classList.add('sel');
      d.onclick = ()=>{
        if(picked.has(opt)){ picked.delete(opt); d.classList.remove('sel');}
        else{ if(picked.size>=max){ alert(`æœ€å¤šé€‰æ‹© ${max} é¡¹`); return; } picked.add(opt); d.classList.add('sel'); }
        answers[q.key] = Array.from(picked);
      };
      optsEl.appendChild(d);
    });
    nextBtn.onclick = ()=>{
      const val = answers[q.key]||[];
      if(val.length===0){ alert('è¯·è‡³å°‘é€‰æ‹© 1 é¡¹'); return; }
      logStep(q.key, q.q, val.join('ã€'));
      next();
    }
  }
  else if(q.type==='likert'){
    const row = document.createElement('div'); row.className='row';
    q.opts.forEach(v=>{
      const b = document.createElement('button'); b.className='btn'; b.textContent=v;
      b.onclick = ()=>{ answers[q.key]=v; logStep(q.key, q.q, v); next(); };
      row.appendChild(b);
    });
    optsEl.appendChild(row);
  }
  else if(q.type==='sliders'){
    q.sliders.forEach(s=>{
      const wrap = document.createElement('div'); wrap.className='chip'; wrap.style.display='block';
      const lab = document.createElement('div'); lab.style.marginBottom='8px'; lab.textContent = s.label;
      const rng = document.createElement('input'); rng.type='range'; rng.min=s.min; rng.max=s.max; rng.value=s.val; rng.step=1;
      const val = document.createElement('span'); val.style.marginLeft='8px'; val.textContent = s.val;
      rng.oninput = ()=>{ val.textContent = rng.value; collect(); };
      wrap.appendChild(lab); wrap.appendChild(rng); wrap.appendChild(val);
      optsEl.appendChild(wrap);
    });
    function collect(){
      const obj={}; const sliders=optsEl.querySelectorAll('input[type=range]');
      sliders.forEach((el,idx)=>{ obj[q.sliders[idx].key]=+el.value; });
      answers[q.key]=obj;
    }
    collect();
    nextBtn.onclick = ()=>{ logStep(q.key, q.q, JSON.stringify(answers[q.key])); next(); }
  }
  else if(q.type==='rank'){
    // B æ–¹æ¡ˆï¼šç‚¹å‡»ä¾æ¬¡ç¡®å®šç¬¬1~ç¬¬8ä½ï¼Œå¯é‡ç½®
    const pool = [...q.items];
    const order = [];
    const poolBox = document.createElement('div');
    const pickedBox = document.createElement('div');
    const resetBtn = document.createElement('button');
    poolBox.className='card'; poolBox.style.background='rgba(255,255,255,.03)'; poolBox.style.margin='8px 0';
    pickedBox.className='card'; pickedBox.style.background='rgba(0,255,208,.06)'; pickedBox.style.margin='8px 0';
    resetBtn.className='btn'; resetBtn.textContent='é‡ç½®';
    const tip = document.createElement('div'); tip.className='muted'; tip.textContent='ç‚¹å‡»ä¸Šæ–¹æ¡ç›®ï¼ŒæŒ‰ä¼˜å…ˆé¡ºåºä¾æ¬¡é€‰æ‹©ã€‚';

    function renderRank(){
      poolBox.innerHTML='<div class="muted">å€™é€‰ï¼š</div>';
      pool.forEach(txt=>{
        const d=document.createElement('div'); d.className='chip'; d.textContent=txt;
        d.onclick=()=>{ pool.splice(pool.indexOf(txt),1); order.push(txt); renderRank(); };
        poolBox.appendChild(d);
      });
      pickedBox.innerHTML='<div class="muted">å·²é€‰é¡ºåºï¼š</div>';
      order.forEach((txt,idx)=>{
        const d=document.createElement('div'); d.className='chip sel'; d.textContent=(idx+1)+'. '+txt;
        pickedBox.appendChild(d);
      });
      answers[q.key]=order.slice();
    }
    resetBtn.onclick=()=>{ pool.splice(0,pool.length,...q.items); order.splice(0,order.length); renderRank(); }
    renderRank();
    optsEl.appendChild(poolBox);
    optsEl.appendChild(pickedBox);
    optsEl.appendChild(tip);
    const action = document.createElement('div'); action.className='actions';
    const ok = document.createElement('button'); ok.className='btn primary'; ok.textContent='å®Œæˆæ­¤é¢˜';
    ok.onclick=()=>{ if((answers[q.key]||[]).length!==q.items.length){ alert('è¯·æŒ‰é¡ºåºé€‰æ»¡æ‰€æœ‰é¡¹'); return; } logStep(q.key, q.q, (answers[q.key]||[]).join(' > ')); next(); };
    action.appendChild(resetBtn); action.appendChild(ok);
    optsEl.appendChild(action);
  }
  else if(q.type==='open'){
    const ta = document.createElement('textarea'); ta.placeholder='ä¾‹å¦‚ï¼šåƒä¸€ä¸ªéšèº«æºå¸¦çš„å®é™èƒ½é‡ç©ºé—´ã€‚';
    ta.oninput = ()=>{ answers[q.key]=ta.value; };
    optsEl.appendChild(ta);
    nextBtn.onclick = ()=>{ logStep(q.key, q.q, (answers[q.key]||'').slice(0,500)); next(); }
  }
}

async function logStep(key, step, answer){
  if(!allowRecord) return;               // ä½“éªŒæ¨¡å¼ä¸è®°
  try{
    await sb.from('answers').insert({
      session: session_id,
      qkey: key,
      step,
      answer,
      time: new Date().toISOString()
    });
  }catch(e){ console.log('log error', e); }
}

function finish(){
  panelEl.style.display='none';
  resultEl.style.display='block';
  if(allowRecord) localStorage.setItem('survey_done','yes');
  resultEl.innerHTML = `
    <div style="font-size:18px;margin-bottom:8px">âœ… å·²æäº¤æˆåŠŸ</div>
    <div class="muted">æ„Ÿè°¢ä½ å‚ä¸ 2035 æœªæ¥å‡ºè¡Œ Â· å…±åˆ›ã€‚<br/>ï¼ˆå¦‚éœ€å†æ¬¡ä½“éªŒï¼Œå¯åˆ·æ–°é¡µé¢å¹¶é€‰æ‹©â€œä»…ä½“éªŒä¸è®°å½•â€ï¼‰</div>
  `;
}

/* å¯åŠ¨ */
next();
</script>
</body>
</html>

